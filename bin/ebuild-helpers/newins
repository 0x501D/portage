#!/bin/bash
# Copyright 1999-2012 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2

source "${PORTAGE_BIN_PATH:-/usr/lib/portage/bin}"/isolated-functions.sh

helper=${0##*/}

if [[ -z ${T} ]] || [[ -z ${2} ]] ; then
	helpers_die "${helper}: Need two arguments, old file and new file"
	exit 1
fi

if [ ! -e "$1" ] ; then
	helpers_die "!!! ${helper}: $1 does not exist"
	exit 1
fi

(($#>2)) && \
	eqawarn "QA Notice: ${helper} called with more than 2 arguments: ${@:3}"

cp_args="-f"
if [[ ${helper} == newins ]] ; then
	case "${EAPI}" in
		0|1|2|3)
			;;
		*)
			cp_args+=" -P"
			;;
	esac
fi

rm -rf "${T}/$2" && \
cp ${cp_args} "$1" "${T}/$2" && \
do${helper#new} "${T}/$2"
ret=$?
rm -rf "${T}/${2}"
[[ $ret -ne 0 ]] && helpers_die "${helper} failed"
exit $ret
